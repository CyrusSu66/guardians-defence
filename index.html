<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>守護者防線 - 核心系統 v1.0</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="layout-grid">
        <!-- 1. LEFT PANEL: Status (Desktop) / Top Bar (Mobile) -->
        <aside id="statsPanel" class="panel-sidebar">
            <div class="app-brand">
                <h1>GD</h1> <!-- Mobile Brand -->
                <span class="desktop-title">Guardians Defence</span>
            </div>

            <div class="stats-container">
                <div class="stat-card shield-stat">
                    <div class="stat-icon">🛡️</div>
                    <div class="stat-info">
                        <label>魔法護罩</label>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="shieldBar" style="width: 100%;"></div>
                        </div>
                        <span class="stat-value-text" id="villageHP">20</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-info">
                        <label>回合</label>
                        <span class="stat-value-text" id="turnNumber">1</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-info">
                        <label>經驗 / 戰果</label>
                        <span class="stat-value-text"><span id="currentXP">0</span> XP | <span id="totalScore">0</span>
                            VP</span>
                    </div>
                </div>

                <div class="stat-card status-state">
                    <div class="stat-info">
                        <label>狀態</label>
                        <span class="stat-value-text" id="gameState">待命</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 2. CENTER PANEL: Main Stage -->
        <main id="stageArea" class="main-stage">

            <div id="headerActions" class="stage-section" style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-primary btn-glow" id="startGameBtn">開始新戰局</button>
            </div>

            <!-- Dungeon Hall -->
            <div id="dungeonPanel" class="stage-section panel-card">
                <div class="panel-header">
                    <h3>⚔️ 地城大廳</h3>
                </div>
                <div class="lane-display">
                    <div class="lane-track" id="laneTrack">
                        <div class="lane-village">🏰 防線</div>
                        <div class="dungeon-rank-slots" id="dungeonRankSlots"></div>
                    </div>
                </div>
                <div id="debugDeckInspector"></div>
            </div>

            <!-- Action Selection -->
            <div id="actionSelectPanel" class="stage-section panel-card action-panel">
                <div class="panel-header">
                    <h3>🚩 行動</h3>
                </div>
                <div class="action-buttons-grid">
                    <button class="btn btn-action" id="btnVisitVillage">
                        <span class="btn-icon">🏪</span> 造訪村莊
                    </button>
                    <button class="btn btn-action" id="btnRest">
                        <span class="btn-icon">💤</span> 休息整補
                    </button>
                    <button class="btn btn-action btn-danger" id="btnEnterDungeon">
                        <span class="btn-icon">⚔️</span> 進入地城
                    </button>
                </div>
            </div>

            <!-- Dynamic Panels (Combat / Rest) -->
            <div id="dynamicPanels" class="stage-section">
                <!-- Rest Panel -->
                <div id="restPanel" class="panel-card active-mode-panel" style="display: none;">
                    <div class="panel-header">
                        <h3>💤 休息中</h3>
                    </div>
                    <div class="panel-body">
                        <div style="margin-bottom: 10px; color: #aaa;">已獲得 1 XP。點擊手牌可銷毀卡片。</div>
                        <button class="btn btn-secondary" onclick="window.game.finishAction()">完成行動</button>
                    </div>
                </div>

                <!-- Combat Panel -->
                <div id="combatPanel" class="panel-card active-mode-panel" style="display: none;">
                    <div class="panel-header">
                        <h3>🗡️ 戰鬥指揮</h3>
                    </div>
                    <div id="combatHeroList" class="combat-hero-slots"
                        style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                    <div id="combatSummary" class="combat-log" style="margin: 15px 0;">尚未部署英雄...</div>
                    <div class="panel-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-primary btn-glow" id="combatAttackBtn">執行攻擊</button>
                        <button class="btn btn-secondary" onclick="window.game.finishAction()">撤退 / 結束</button>
                    </div>
                </div>
            </div>

            <!-- Village / Market -->
            <div id="villagePanel" class="stage-section panel-card village-panel">
                <div class="panel-header">
                    <h3>🏛️ 村莊市集</h3>
                    <div class="coin-badge" style="background: #333; padding: 5px 10px; border-radius: 4px;">
                        💰 <span id="plazaCoinDisplay">0</span>
                    </div>
                </div>
                <!-- Controls for finishing village actions (hidden by default) -->
                <div id="villageFinishControl"
                    style="margin: 10px 0; display: none; justify-content: flex-end; gap: 10px;">
                    <button class="btn btn-secondary" onclick="window.game.activateAllResources()">💰 啟用資源</button>
                    <button class="btn btn-primary" onclick="window.game.finishAction()">結束村莊行動</button>
                </div>

                <div class="plaza-tabs" style="margin-bottom: 15px;">
                    <button class="plaza-tab-btn active" id="tab-market">廣場市集</button>
                </div>
                <!-- Market Content injected by JS -->
                <div id="marketTab" class="plaza-content active">
                    <div id="marketGrid" class="market-display-grid"></div>
                </div>
                <div id="trainingTab" class="plaza-content">
                    <div id="trainingHeroes"></div>
                </div>
            </div>

            <!-- Training Panel -->
            <div id="trainingPanel" class="stage-section panel-card training-panel" style="display: none;">
                <div class="panel-header">
                    <h3>⚔️ 訓練場</h3>
                </div>
                <div id="trainingContent"></div>
            </div>

        </main>

        <!-- 3. RIGHT PANEL: Log (Desktop) -->
        <aside id="logPanel" class="panel-sidebar log-sidebar">
            <div class="panel-header" style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
                <h3>📜 冒險日誌</h3>
            </div>
            <div class="log-content expanded-log" id="gameLog">
                <div class="log-entry info">系統初始化完成...</div>
            </div>
        </aside>

        <!-- 4. BOTTOM DOCK: Hand (Drawer on Mobile) -->
        <div id="handDock" class="hand-dock">
            <div class="dock-handle mobile-only" id="handDrawerHandle">
                <span class="handle-bar" style="width: 40px; height: 4px; background: #555; border-radius: 2px;"></span>
                <span class="hand-summary" style="margin-left: 10px; font-size: 12px;">手牌 (<span
                        id="btnDeckCount">0</span>)</span>
            </div>
            <div class="dock-content">
                <div class="hand-controls" style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <div class="panel-title desktop-only">🎴 戰略手牌</div>
                    <div class="deck-status" style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="font-size: 10px; padding: 4px 8px;"
                            onclick="window.game.showDeckModal('deck')">📚 牌庫 (<span
                                id="btnDeckCount">0</span>)</button>
                        <button class="btn btn-secondary" style="font-size: 10px; padding: 4px 8px;"
                            onclick="window.game.showDeckModal('discard')">🗑️ 棄牌 (<span
                                id="btnDiscardCount">0</span>)</button>
                    </div>
                </div>
                <div class="hand-area">
                    <div id="playedCardsDisplay" class="played-cards-area" style="display: flex; gap: 5px;"></div>
                    <div class="hand-cards" id="handDisplay" style="display: flex; gap: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Overlay) -->
    <div id="deckModal" class="modal-overlay">
        <div class="modal-content deck-view">
            <h3 id="deckModalTitle">牌庫檢視</h3>
            <div id="deckModalContent" class="deck-view-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('deckModal').classList.remove('active')">關閉</button>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content deck-view">
            <h3 id="infoModalTitle">卡牌詳情</h3>
            <div id="infoModalContent" style="font-size: 14px; line-height: 1.6;"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('infoModal').classList.remove('active')">關閉</button>
            </div>
        </div>
    </div>

    <!-- End Game Modal -->
    <div class="modal" id="endGameModal">
        <div class="modal-content">
            <h2 id="endGameTitle">戰報</h2>
            <p id="endGameMessage"></p>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="location.reload()">重新啟動系統</button>
        </div>
    </div>

    <script type="module" src="src/game.js"></script>
    <script>
        // Start Game
        const startBtn = document.getElementById('startGameBtn');
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                if (window.game) window.game.start();
            });
        }

        // Mobile Drawer Toggle
        const handle = document.getElementById('handDrawerHandle');
        const dock = document.getElementById('handDock');
        if (handle && dock) {
            handle.addEventListener('click', () => {
                dock.classList.toggle('expanded');
            });
        }
    </script>
</body>

</html>