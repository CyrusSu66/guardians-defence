<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆè­·è€…é˜²ç·š - å¡ç‰ŒéŠæˆ² v2.3 (Spell & Craft)</title>
    <style>
        :root {
            --color-bg: #1a1a1a;
            --color-surface: #2d2d2d;
            --color-text: #f0f0f0;
            --color-primary: #2db8c6;
            --color-accent: #ff5a59;
            --color-success: #21808d;
            --color-warning: #e6b800;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--color-bg); color: var(--color-text); font-family: Arial, sans-serif; padding: 20px; }
        .game-container { max-width: 1600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: var(--color-primary); }
        .game-board { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .panel-title { color: var(--color-primary); font-weight: bold; margin-bottom: 10px; font-size: 16px; }

        .status-item { background-color: var(--color-bg); padding: 12px; border-radius: 6px; border-left: 4px solid var(--color-primary); margin-bottom: 10px; }
        .status-label { font-size: 12px; color: #aaa; text-transform: uppercase; }
        .status-value { font-size: 24px; font-weight: bold; color: var(--color-primary); margin-top: 5px; }
        .status-value.danger { color: var(--color-accent); }

        .lane-display { background-color: var(--color-bg); border: 1px solid var(--color-primary); border-radius: 6px; padding: 15px; min-height: 140px; overflow-x: auto; }
        .lane-track { display: flex; align-items: center; gap: 8px; min-width: min-content; }
        .lane-village { background-color: var(--color-bg); border: 2px solid var(--color-success); border-radius: 6px; padding: 10px; min-width: 60px; text-align: center; font-size: 12px; font-weight: bold; color: var(--color-success); flex-shrink: 0; }
        .lane-arrow { color: var(--color-primary); font-size: 16px; flex-shrink: 0; }
        .lane-slots { display: flex; gap: 8px; align-items: center; }
        .lane-slot { background-color: var(--color-bg); border: 2px solid rgba(45, 184, 198, 0.3); border-radius: 6px; padding: 8px; min-width: 85px; min-height: 80px; text-align: center; font-size: 11px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .lane-slot.occupied { border-color: var(--color-accent); background-color: rgba(255, 90, 89, 0.1); }
        .lane-slot.damaged { animation: damageFlash 1s infinite alternate; border: 2px solid red; }
        @keyframes damageFlash { from { box-shadow: 0 0 5px red; } to { box-shadow: 0 0 15px red; } }
        .damage-number { position: absolute; color: #ff3a39; font-size: 20px; font-weight: bold; pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 10; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-30px); opacity: 0; } }
        .lane-slot-monster-name { font-weight: bold; margin-bottom: 5px; }
        .lane-slot-hp { font-size: 10px; color: var(--color-accent); }
        .lane-slot-distance { position: absolute; top: 3px; right: 5px; font-size: 10px; color: #aaa; }

        .hand-area { background-color: var(--color-bg); border: 1px solid var(--color-primary); border-radius: 6px; padding: 15px; min-height: 120px; }
        .hand-cards { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px; }
        .card { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 6px; padding: 10px; min-width: 80px; text-align: center; cursor: pointer; transition: all 0.2s; font-size: 12px; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: #fff; box-shadow: 0 4px 8px rgba(45, 184, 198, 0.3); }
        .card.selected { border-color: #fff; background-color: rgba(45, 184, 198, 0.2); border: 2px solid var(--color-success); }
        .card.disabled { opacity: 0.5; cursor: not-allowed; }
        .card-name { font-weight: bold; margin-bottom: 5px; }
        .card-value { background-color: var(--color-bg); padding: 5px; border-radius: 4px; font-size: 11px; color: var(--color-primary); }
        
        /* ç‰Œå †æŸ¥çœ‹æŒ‰éˆ• */
        .deck-status { display: flex; gap: 10px; margin-bottom: 10px; }
        .deck-btn { padding: 5px 10px; background-color: var(--color-surface); border: 1px solid var(--color-primary); color: #aaa; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .deck-btn:hover { color: #fff; border-color: #fff; }

        /* å¡ç‰Œå‹•ä½œæŒ‰éˆ• (æ³•è¡“ç”¨) */
        .card-action-btn { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background-color: var(--color-warning); color: #1a1a1a; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; cursor: pointer; white-space: nowrap; z-index: 5; display: none; }
        .card:hover .card-action-btn { display: block; }
        .card.disabled .card-action-btn { display: none; }

        .hand-confirmation-area { background-color: var(--color-bg); border: 1px dashed var(--color-primary); border-radius: 6px; padding: 12px; min-height: 50px; display: flex; align-items: center; gap: 10px; }
        .confirmation-cards { display: flex; gap: 8px; flex-wrap: wrap; flex: 1; }
        .confirmation-card { background-color: var(--color-surface); border: 2px solid var(--color-success); border-radius: 4px; padding: 8px; font-size: 11px; text-align: center; }
        .confirmation-card-name { font-weight: bold; }
        .confirmation-card-value { color: var(--color-success); font-size: 10px; margin-top: 3px; }
        .confirmation-btns { display: flex; gap: 5px; }
        .btn-confirm-coin { padding: 8px 12px; background-color: var(--color-success); border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 11px; white-space: nowrap; }
        .btn-confirm-coin:hover:not(:disabled) { background-color: #1a6570; }
        .btn-confirm-coin:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-clear-selection { padding: 8px 10px; background-color: var(--color-accent); border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 11px; }
        .btn-clear-selection:hover { background-color: #ff3a39; }

        .action-buttons { display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
        .btn-primary { background-color: var(--color-primary); color: var(--color-bg); }
        .btn-primary:hover:not(:disabled) { background-color: #1fa5b5; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background-color: var(--color-accent); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #ff3a39; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }

        .village-plaza { background-color: var(--color-bg); border: 1px solid var(--color-primary); border-radius: 6px; padding: 15px; }
        .plaza-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .plaza-coin-display { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 6px; padding: 10px 15px; text-align: center; }
        .plaza-coin-label { font-size: 11px; color: #aaa; text-transform: uppercase; }
        .plaza-coin-value { font-size: 20px; font-weight: bold; color: var(--color-accent); margin-top: 3px; }
        .plaza-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid var(--color-primary); }
        .plaza-tab-btn { padding: 10px 15px; background-color: transparent; border: none; border-bottom: 3px solid transparent; color: #aaa; cursor: pointer; font-weight: bold; transition: all 0.2s; font-size: 13px; }
        .plaza-tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .plaza-tab-btn:hover { color: var(--color-text); }
        .plaza-content { display: none; min-height: 180px; }
        .plaza-content.active { display: block; }

        .market-display-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .market-item { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 6px; padding: 10px; text-align: center; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .market-item:hover { border-color: #fff; box-shadow: 0 2px 6px rgba(45, 184, 198, 0.3); }
        .market-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .market-item-name { font-weight: bold; margin-bottom: 5px; }
        .market-item-cost { color: var(--color-accent); font-size: 11px; margin-top: 5px; font-weight: bold; }
        .market-item-desc { font-size: 10px; color: #aaa; margin-top: 5px; line-height: 1.3; }

        .training-heroes, .crafting-list { display: flex; flex-direction: column; gap: 10px; }
        .training-hero-item, .crafting-item { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 6px; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .training-hero-info, .crafting-info { flex: 1; }
        .training-hero-name, .crafting-name { font-weight: bold; margin-bottom: 5px; }
        .training-hero-cost, .crafting-cost { font-size: 12px; color: var(--color-accent); }
        .training-upgrade-btn, .crafting-btn { padding: 8px 12px; background-color: var(--color-primary); border: none; border-radius: 4px; color: var(--color-bg); font-weight: bold; cursor: pointer; transition: all 0.2s; font-size: 12px; }
        .training-upgrade-btn:hover:not(:disabled), .crafting-btn:hover:not(:disabled) { background-color: #1fa5b5; }
        .training-upgrade-btn:disabled, .crafting-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .placeholder-text { color: #666; text-align: center; padding: 40px 20px; font-size: 14px; }

        .log-panel { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .log-title { color: var(--color-primary); font-weight: bold; margin-bottom: 10px; }
        .log-content { background-color: var(--color-bg); border-radius: 6px; padding: 12px; max-height: 120px; overflow-y: auto; font-size: 12px; line-height: 1.6; }
        .log-entry { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid rgba(45, 184, 198, 0.2); }
        .log-entry.info { color: var(--color-primary); }
        .log-entry.danger { color: var(--color-accent); }
        .log-entry.success { color: var(--color-success); }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 8px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; text-align: center; }
        .modal-content h2 { color: var(--color-primary); margin-bottom: 20px; }
        
        .card-list-modal { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
        .card-list-item { background: var(--color-bg); border: 1px solid #666; padding: 8px; border-radius: 4px; font-size: 11px; }
        .close-modal-btn { margin-top: 20px; padding: 8px 16px; background: #666; border: none; color: white; border-radius: 4px; cursor: pointer; }

        @media (max-width: 1200px) {
            .game-board { grid-template-columns: 1fr; }
            .lane-track { flex-wrap: wrap; }
            .lane-slots { width: 100%; }
        }
    </style>
</head>
<body>
<div class="game-container">
    <h1>âš”ï¸ å®ˆè­·è€…é˜²ç·š Prototype v2.3 - æ³•è¡“ & é›é€ </h1>

    <!-- æ—¥èªŒï¼ˆæœ€ä¸Šæ–¹ï¼‰ -->
    <div class="log-panel">
        <div class="log-title">ğŸ“œ éŠæˆ²æ—¥èªŒ</div>
        <div class="log-content" id="gameLog">
            <div class="log-entry info">æ­¡è¿ä¾†åˆ° ã€Šå®ˆè­·è€…é˜²ç·šã€‹v2.3</div>
        </div>
    </div>

    <div class="game-board">
        <!-- å·¦å´ï¼šæ‘èŠç‹€æ…‹ -->
        <div class="panel">
            <div class="panel-title">ğŸ° æ‘èŠç‹€æ…‹</div>
            <div class="status-item">
                <div class="status-label">æ‘èŠè¡€é‡</div>
                <div class="status-value" id="villageHP">20</div>
            </div>
            <div class="status-item">
                <div class="status-label">ç´¯ç©XP (ä¿ç•™)</div>
                <div class="status-value" id="currentXP">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">èƒ½é‡çµæ™¶</div>
                <div class="status-value" id="crystals">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">ç´¯ç©åˆ†æ•¸</div>
                <div class="status-value" id="totalScore">0</div>
            </div>
        </div>

        <!-- ä¸­å¤®ï¼šéŠæˆ²å€ -->
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="panel">
                <div class="panel-title">âš”ï¸ æ€ªç‰©è»Œé“</div>
                <div class="lane-display">
                    <div class="lane-track" id="laneTrack">
                        <div class="lane-village">ğŸ°<br>æ‘èŠ</div>
                        <div class="lane-arrow">â†’</div>
                        <div class="lane-slots" id="laneSlots"></div>
                    </div>
                </div>
            </div>

            <!-- æˆ°é¬¥é¸æ“‡ UI -->
            <div class="panel" id="combatPanel" style="display: none;">
                <div class="panel-title">ğŸ—¡ï¸ æˆ°é¬¥æŒ‡ä»¤</div>
                <div style="font-size:12px; color:#aaa; line-height:1.6; margin-bottom:10px;">
                    æˆ°é¬¥éšæ®µï¼šé¸è‹±é›„/æ­¦å™¨æ”»æ“Šï¼Œæˆ–é»æ“Šæ‰‹ç‰Œä¸­ã€Œæˆ°é¬¥æ³•è¡“ã€ç›´æ¥ç™¼å‹•ã€‚
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:240px; background:var(--color-bg); border:1px solid var(--color-primary); border-radius:6px; padding:10px;">
                        <div style="font-weight:bold; color:var(--color-primary); margin-bottom:8px;">è‹±é›„</div>
                        <div id="combatHeroList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                    </div>
                    <div style="flex:1; min-width:240px; background:var(--color-bg); border:1px solid var(--color-primary); border-radius:6px; padding:10px;">
                        <div style="font-weight:bold; color:var(--color-primary); margin-bottom:8px;">æ­¦å™¨ï¼ˆå¯é¸ï¼Œéœ€è² é‡ï¼‰</div>
                        <div id="combatWeaponList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                    </div>
                </div>
                <div style="margin-top:10px; background:var(--color-bg); border:1px dashed var(--color-primary); border-radius:6px; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <div id="combatSummary" style="font-size:12px; color:#aaa; line-height:1.6; flex:1;">å°šæœªé¸æ“‡</div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-primary" id="combatAttackBtn" onclick="game.performAttack()">æ”»æ“Š</button>
                        <button class="btn btn-secondary" id="combatEndBtn" onclick="game.skipCombat()">çµæŸæˆ°é¬¥ â†’ æ€ªç‰©é€²è»</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div class="panel-title" style="margin-bottom:0;">ğŸ´ æ‰‹ç‰Œå€</div>
                    <div class="deck-status">
                        <div class="deck-btn" onclick="game.showDeckModal('deck')">ç‰Œåº«: <span id="deckCount">0</span></div>
                        <div class="deck-btn" onclick="game.showDeckModal('discard')">æ£„ç‰Œ: <span id="discardCount">0</span></div>
                    </div>
                </div>
                <div class="hand-area">
                    <div class="hand-cards" id="handDisplay">
                        <span style="color: #999; font-size: 12px;">éŠæˆ²é–‹å§‹å¾Œé¡¯ç¤ºæ‰‹ç‰Œ...</span>
                    </div>
                    <div class="hand-confirmation-area" id="confirmationArea" style="display: none;">
                        <div class="confirmation-cards" id="confirmationCards"></div>
                        <div class="confirmation-btns">
                            <button class="btn-confirm-coin" id="confirmCoinBtn" onclick="game.confirmCoin()">âœ“ ç¢ºèªå–å¾—</button>
                            <button class="btn-clear-selection" onclick="game.clearSelection()">âœ• æ¸…é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel village-plaza">
                <div class="plaza-header">
                    <div class="panel-title">ğŸ›ï¸ æ‘èŠå»£å ´</div>
                    <div class="plaza-coin-display">
                        <div class="plaza-coin-label">ç•¶å‰Coin</div>
                        <div class="plaza-coin-value" id="plazaCoinDisplay">0</div>
                    </div>
                </div>

                <div class="plaza-tabs">
                    <button class="plaza-tab-btn active" onclick="switchPlazaTab('market')">ğŸ›’ å¸‚å ´</button>
                    <button class="plaza-tab-btn" onclick="switchPlazaTab('training')">âš”ï¸ è¨“ç·´å ´</button>
                    <button class="plaza-tab-btn" onclick="switchPlazaTab('craft')">ğŸ”¨ é›é€ </button>
                </div>

                <!-- å¸‚å ´é ç±¤ -->
                <div class="plaza-content active" id="marketTab">
                    <div class="market-display-grid" id="marketGrid"></div>
                </div>

                <!-- è¨“ç·´å ´é ç±¤ -->
                <div class="plaza-content" id="trainingTab">
                    <div class="training-heroes" id="trainingHeroes"></div>
                </div>

                <!-- é›é€ é ç±¤ -->
                <div class="plaza-content" id="craftTab">
                    <div class="crafting-list" id="craftingList"></div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šæ“ä½œé¢æ¿ -->
        <div class="panel">
            <div class="panel-title">ğŸ“Š å›åˆè³‡è¨Š</div>
            <div class="status-item">
                <div class="status-label">ç•¶å‰å›åˆ</div>
                <div class="status-value" id="turnNumber">1</div>
            </div>
            <div class="status-item">
                <div class="status-label">éŠæˆ²ç‹€æ…‹</div>
                <div class="status-value" style="font-size: 14px;" id="gameState">æº–å‚™ä¸­</div>
            </div>

            <div class="panel-title" style="margin-top: 20px;">ğŸ® æ“ä½œ</div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="startGameBtn" onclick="game.startNewGame()">é–‹å§‹æ–°éŠæˆ²</button>
                <button class="btn btn-primary" id="nextPhaseBtn" onclick="game.nextPhase()" disabled>ä¸‹ä¸€å€‹éšæ®µ</button>
                <button class="btn btn-secondary" id="endTurnBtn" onclick="game.endTurn()" disabled>çµæŸå›åˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- éŠæˆ²çµæŸ Modal -->
<div class="modal" id="endGameModal">
    <div class="modal-content">
        <h2 id="endGameTitle">éŠæˆ²çµæŸ</h2>
        <p id="endGameMessage">éŠæˆ²å·²çµæŸ</p>
        <button class="btn btn-primary" onclick="game.startNewGame(); document.getElementById('endGameModal').classList.remove('active')">é‡æ–°é–‹å§‹</button>
    </div>
</div>

<!-- æŸ¥çœ‹ç‰Œå † Modal -->
<div class="modal" id="deckViewModal">
    <div class="modal-content">
        <h2 id="deckViewTitle">ç‰Œå †æ¸…å–®</h2>
        <div id="deckViewList" class="card-list-modal"></div>
        <button class="close-modal-btn" onclick="document.getElementById('deckViewModal').classList.remove('active')">é—œé–‰</button>
    </div>
</div>

<script>
    const GameState = { IDLE: 'IDLE', DRAW: 'DRAW', VILLAGE: 'VILLAGE', COMBAT: 'COMBAT', MONSTER_ADVANCE: 'MONSTER_ADVANCE', END_TURN: 'END_TURN', GAME_OVER: 'GAME_OVER' };

    // ===== è³‡æ–™åº« =====
    const CARDPOOL = {
        heroes: [
            { id: 'hero_warrior_lv1', name: 'æˆ°å£«(Lv1)', class: 'Warrior', attack: 2, range: 1, carry: 4, xpToUpgrade: 3, upgradeToId: 'hero_warrior_lv2', desc: 'è¿‘æˆ°ç¡¬æ‰“å‹' },
            { id: 'hero_warrior_lv2', name: 'æˆ°å£«(Lv2)', class: 'Warrior', attack: 3, range: 1, carry: 5, xpToUpgrade: 5, upgradeToId: 'hero_warrior_lv3', desc: 'æ›´å¼·çš„è¿‘æˆ°æˆ°å£«' },
            { id: 'hero_warrior_lv3', name: 'æˆ°å£«(Lv3)', class: 'Warrior', attack: 4, range: 1, carry: 6, desc: 'çµ‚æ¥µè¿‘æˆ°æˆ°å£«' },
            { id: 'hero_ranger_lv1', name: 'å°„æ‰‹(Lv1)', class: 'Ranger', attack: 1, range: 3, carry: 3, xpToUpgrade: 3, upgradeToId: 'hero_ranger_lv2', desc: 'é ç¨‹ç²¾æº–å°„æ‰‹' },
            { id: 'hero_ranger_lv2', name: 'å°„æ‰‹(Lv2)', class: 'Ranger', attack: 2, range: 4, carry: 3, xpToUpgrade: 5, upgradeToId: 'hero_ranger_lv3', desc: 'æ›´é çš„å°„ç¨‹' },
            { id: 'hero_ranger_lv3', name: 'å°„æ‰‹(Lv3)', class: 'Ranger', attack: 3, range: 5, carry: 3, desc: 'çµ‚æ¥µé ç¨‹ç‹™æ“Š' },
            { id: 'hero_mage_lv1', name: 'æ³•å¸«(Lv1)', class: 'Mage', attack: 1, range: 4, carry: 2, xpToUpgrade: 3, upgradeToId: 'hero_mage_lv2', desc: 'é­”æ³•é è·æ³•å¸«' },
            { id: 'hero_mage_lv2', name: 'æ³•å¸«(Lv2)', class: 'Mage', attack: 2, range: 4, carry: 2, xpToUpgrade: 5, upgradeToId: 'hero_mage_lv3', desc: 'æ›´å¼·çš„é­”æ³•å¨åŠ›' },
            { id: 'hero_mage_lv3', name: 'æ³•å¸«(Lv3)', class: 'Mage', attack: 3, range: 5, carry: 2, desc: 'çµ‚æ¥µé­”æ³•å¤§å¸«' },
            { id: 'hero_rogue_lv1', name: 'ç›œè³Š(Lv1)', class: 'Rogue', attack: 1, range: 2, carry: 3, passiveGold: 1, xpToUpgrade: 3, upgradeToId: 'hero_rogue_lv2', desc: 'é‡‘æµå‹ç›œè³Š' },
            { id: 'hero_rogue_lv2', name: 'ç›œè³Š(Lv2)', class: 'Rogue', attack: 2, range: 2, carry: 3, passiveGold: 2, xpToUpgrade: 5, upgradeToId: 'hero_rogue_lv3', desc: 'æ›´å¼·çš„é‡‘æµæŒæ§' },
            { id: 'hero_rogue_lv3', name: 'ç›œè³Š(Lv3)', class: 'Rogue', attack: 2, range: 3, carry: 3, passiveGold: 3, desc: 'çµ‚æ¥µé‡‘æµæŒæ§è€…' },
            { id: 'hero_magic_sword', name: 'é­”æ³•æˆ°å£«', class: 'Warrior', attack: 4, range: 1, carry: 6, desc: 'é›é€ å‡ºçš„å¼·åŠ›æˆ°å£«' }
        ],
        weapons: [
            { id: 'weapon_iron_sword', name: 'éµåŠ', attack: 2, range: 1, weight: 3, desc: 'å …å›ºçš„éµåŠ' },
            { id: 'weapon_wooden_bow', name: 'æœ¨å¼“', attack: 2, range: 3, weight: 2, desc: 'è¼•å·§çš„å¼“' },
            { id: 'weapon_fire_staff', name: 'ç«ç„°æ³•æ–', attack: 2, range: 4, weight: 1, desc: 'ç‚ç†±çš„æ³•æ–' },
            { id: 'weapon_dagger', name: 'åŒ•é¦–', attack: 1, range: 1, weight: 1, desc: 'è¼•å¿«çš„åŒ•é¦–' },
            { id: 'weapon_magic_blade', name: 'é­”æ³•åŠ', attack: 4, range: 1, weight: 3, desc: 'è˜Šå«é­”åŠ›çš„åˆ©åˆƒ' }
        ],
        economy: [
            { id: 'eco_copper_coin', name: 'éŠ…å¹£', coin: 1, desc: 'åŸºç¤è²¨å¹£ +1' },
            { id: 'eco_silver_coin', name: 'éŠ€å¹£', coin: 2, desc: 'å¸¸è¦‹è²¨å¹£ +2' },
            { id: 'eco_ruby', name: 'ç´…å¯¶çŸ³', coin: 2, desc: 'å¯¶çŸ³ +2' }
        ],
        spells: [
            { id: 'spell_draw_1', name: 'æŠ½ç‰Œè¡“', usage: 'village', desc: 'ã€æ‘èŠã€‘æŠ½ 2 å¼µç‰Œ' },
            { id: 'spell_damage', name: 'çˆ†è£‚ç«ç„°', usage: 'combat', damage: 3, desc: 'ã€æˆ°é¬¥ã€‘é€ æˆ 3 å‚·å®³' },
            { id: 'spell_big_fire', name: 'å¤§ç«çƒè¡“', usage: 'combat', damage: 5, desc: 'ã€æˆ°é¬¥ã€‘é€ æˆ 5 å‚·å®³' }
        ],
        items: [
            { id: 'item_heal', name: 'æ²»ç™‚è—¥æ°´', usage: 'village', desc: 'æ¢å¾© 3 è¡€' },
            { id: 'item_xp_scroll', name: 'ç¶“é©—æ²è»¸', xp: 2, desc: '+2 XP' }
        ],
        monsters: [
            { id: 'mon_goblin', name: 'å“¥å¸ƒæ—', hp: 3, maxHp: 3, damage: 1, xp: 1, score: 2, crystal: 1, tier: 1 },
            { id: 'mon_skeleton', name: 'éª·é«å…µ', hp: 2, maxHp: 2, damage: 1, xp: 1, score: 2, crystal: 1, tier: 1 },
            { id: 'mon_zombie', name: 'æ®­å±', hp: 4, maxHp: 4, damage: 2, xp: 2, score: 3, crystal: 1, tier: 1 },
            { id: 'mon_wolf', name: 'é‡ç‹¼', hp: 3, maxHp: 3, damage: 1, xp: 2, score: 2, crystal: 1, tier: 1 },
            { id: 'mon_spider', name: 'å·¨å¤§èœ˜è››', hp: 5, maxHp: 5, damage: 2, xp: 2, score: 3, crystal: 1, tier: 1 },
            { id: 'mon_orc', name: 'ç¸äººæˆ°å£«', hp: 6, maxHp: 6, damage: 2, xp: 3, score: 5, crystal: 1, tier: 2 },
            { id: 'mon_dragon', name: 'å¹¼é¾', hp: 12, maxHp: 12, damage: 5, xp: 8, score: 15, crystal: 2, tier: 3 }
        ]
    };

    const MARKET_CARDS = {
        early: [
            { id: 'hero_warrior_lv1', name: 'æˆ°å£«(Lv1)', cost: 3 },
            { id: 'hero_ranger_lv1', name: 'å°„æ‰‹(Lv1)', cost: 3 },
            { id: 'hero_mage_lv1', name: 'æ³•å¸«(Lv1)', cost: 3 },
            { id: 'hero_rogue_lv1', name: 'ç›œè³Š(Lv1)', cost: 3 },
            { id: 'weapon_iron_sword', name: 'éµåŠ', cost: 4 },
            { id: 'weapon_wooden_bow', name: 'æœ¨å¼“', cost: 4 },
            { id: 'eco_silver_coin', name: 'éŠ€å¹£', cost: 2 },
            { id: 'eco_ruby', name: 'ç´…å¯¶çŸ³', cost: 3 },
            { id: 'spell_draw_1', name: 'æŠ½ç‰Œè¡“', cost: 2 },
            { id: 'spell_damage', name: 'çˆ†è£‚ç«ç„°', cost: 3 },
            { id: 'item_heal', name: 'æ²»ç™‚è—¥æ°´', cost: 3 }
        ]
    };

    const CRAFTING_RECIPES = [
        { id: 'weapon_magic_blade', name: 'é­”æ³•åŠ', costCoin: 5, costCrystal: 1, desc: 'éœ€ 5 Coin + 1 çµæ™¶' },
        { id: 'spell_big_fire', name: 'å¤§ç«çƒè¡“', costCoin: 3, costCrystal: 1, desc: 'éœ€ 3 Coin + 1 çµæ™¶' }
    ];

    class GuardiansDefenceGame {
        constructor() {
            this.state = GameState.IDLE;
            this.turn = 0;
            this.villageHP = 20; this.maxVillageHP = 20;
            this.currentGold = 0; this.currentXP = 0; this.crystals = 0; this.totalScore = 0;
            this.deck = []; this.hand = []; this.discard = []; this.lane = [];
            this.selectedCards = []; this.playedCards = []; this.combat = null; this.log = [];
        }

        getCardById(cardId) {
            const pools = [
                { arr: CARDPOOL.heroes, type: 'Hero' },
                { arr: CARDPOOL.weapons, type: 'Weapon' },
                { arr: CARDPOOL.economy, type: 'Economy' },
                { arr: CARDPOOL.spells, type: 'Spell' },
                { arr: CARDPOOL.items, type: 'Item' }
            ];
            for (const pool of pools) {
                const card = pool.arr.find(c => c.id === cardId);
                if (card) return { ...card, type: card.type || pool.type };
            }
            return null;
        }

        startNewGame() {
            this.state = GameState.IDLE;
            this.turn = 0;
            this.villageHP = this.maxVillageHP;
            this.currentGold = 0; this.currentXP = 0; this.crystals = 0; this.totalScore = 0;
            this.deck = []; this.hand = []; this.discard = []; this.lane = [];
            this.selectedCards = []; this.playedCards = []; this.combat = null; this.log = [];

            // èµ·å§‹ç‰Œçµ„ 6 å¼µ
            this.deck.push(
                { ...this.getCardById('eco_copper_coin') },
                { ...this.getCardById('eco_copper_coin') },
                { ...this.getCardById('eco_copper_coin') },
                { ...this.getCardById('eco_silver_coin') },
                { ...this.getCardById('hero_warrior_lv1') },
                { ...this.getCardById('spell_draw_1') } // é€ä¸€å¼µæŠ½ç‰Œè¡“æ¸¬è©¦ç”¨
            );

            this.addLog('éŠæˆ²é–‹å§‹ï¼', 'success');
            this.nextTurn();
        }

        nextTurn() {
            this.turn++;
            this.currentGold = 0;
            this.selectedCards = [];
            this.playedCards = [];
            this.combat = null;

            this.state = GameState.DRAW;
            this.addLog(`ã€å›åˆ ${this.turn}ã€‘é–‹å§‹`, 'info');
            this.drawCards(6);
            this.updateUI();

            setTimeout(() => {
                this.state = GameState.VILLAGE;
                this.addLog('é€²å…¥æ‘èŠæ•´å‚™éšæ®µ', 'info');
                this.updateUI();
            }, 300);
        }

        drawCards(count) {
            for (let i = 0; i < count; i++) {
                if (this.deck.length === 0) {
                    if (this.discard.length === 0) break;
                    this.deck = [...this.discard];
                    this.discard = [];
                    // æ´—ç‰Œ
                    for (let j = this.deck.length - 1; j > 0; j--) {
                        const k = Math.floor(Math.random() * (j + 1));
                        [this.deck[j], this.deck[k]] = [this.deck[k], this.deck[j]];
                    }
                }
                const card = this.deck.pop();
                this.hand.push(card);
            }
        }

        // é»é¸å¡ç‰Œ (Coin/XP)
        toggleCardSelection(index) {
            if (this.state !== GameState.VILLAGE) return;
            const card = this.hand[index];
            if (!card) return;
            if (card.coin === undefined && card.xp === undefined) return;

            const existIdx = this.selectedCards.findIndex(c => c.index === index);
            if (existIdx >= 0) this.selectedCards.splice(existIdx, 1);
            else this.selectedCards.push({ index, card });
            this.updateUI();
        }

        confirmCoin() {
            if (this.selectedCards.length === 0) return;
            let totalCoin = 0;
            this.selectedCards.forEach(item => {
                if (item.card.coin !== undefined) totalCoin += item.card.coin;
                if (item.card.xp !== undefined) this.currentXP += item.card.xp;
            });
            this.currentGold += totalCoin;
            if (totalCoin > 0) this.addLog(`å–å¾— ${totalCoin} Coin (ç¸½è¨ˆ: ${this.currentGold})`, 'success');

            const indicesToRemove = this.selectedCards.map(item => item.index).sort((a, b) => b - a);
            indicesToRemove.forEach(idx => {
                this.playedCards.push(this.hand[idx]);
                this.hand.splice(idx, 1);
            });
            this.selectedCards = [];
            this.updateUI();
        }

        clearSelection() { this.selectedCards = []; this.updateUI(); }

        // æ‰“å‡ºæ‘èŠæ³•è¡“ (Draw, Heal)
        playVillageSpell(index) {
            if (this.state !== GameState.VILLAGE) return;
            const card = this.hand[index];
            
            if (card.id === 'spell_draw_1') {
                this.addLog(`ç™¼å‹• ${card.name}ï¼šæŠ½ 2 å¼µç‰Œ`, 'success');
                this.discard.push(this.hand[index]);
                this.hand.splice(index, 1);
                this.drawCards(2);
            }
            else if (card.id === 'item_heal') {
                const heal = 3;
                this.villageHP = Math.min(this.maxVillageHP, this.villageHP + heal);
                this.addLog(`ä½¿ç”¨ ${card.name}ï¼šæ‘èŠæ¢å¾© ${heal} HP`, 'success');
                this.discard.push(this.hand[index]);
                this.hand.splice(index, 1);
            }
            this.updateUI();
        }

        // æ‰“å‡ºæˆ°é¬¥æ³•è¡“ (Damage)
        playCombatSpell(index) {
            if (this.state !== GameState.COMBAT) return;
            if (this.combat.targetDistance === null) {
                this.addLog('è«‹å…ˆé»é¸æ€ªç‰©ç›®æ¨™ï¼', 'danger');
                return;
            }

            const card = this.hand[index];
            const dmg = card.damage || 0;
            const dist = this.combat.targetDistance;
            const target = this.lane.find(m => m.distance === dist);

            if (!target) {
                this.addLog('ç›®æ¨™ä¸å­˜åœ¨', 'danger');
                return;
            }

            this.addLog(`ğŸ”¥ ç™¼å‹• ${card.name}ï¼šé€ æˆ ${dmg} å‚·å®³`, 'success');
            target.hp -= dmg;
            this.showDamage(dist, dmg);
            
            this.discard.push(this.hand[index]);
            this.hand.splice(index, 1);

            if (target.hp <= 0) this.killMonster(target);
            else this.addLog(`${target.name} å‰©é¤˜ HP: ${target.hp}`, 'info');

            this.updateUI();
        }

        buyCard(cardId, cost) {
            if (this.currentGold < cost) { this.addLog('Coin ä¸è¶³ï¼', 'danger'); return; }
            this.currentGold -= cost;
            const card = this.getCardById(cardId);
            if (card) {
                this.discard.push({ ...card });
                this.addLog(`è³¼è²· ${card.name}`, 'success');
            }
            this.updateUI();
        }

        craftCard(cardId, costCoin, costCrystal) {
            if (this.currentGold < costCoin) { this.addLog('Coin ä¸è¶³ï¼', 'danger'); return; }
            if (this.crystals < costCrystal) { this.addLog('çµæ™¶ä¸è¶³ï¼', 'danger'); return; }

            this.currentGold -= costCoin;
            this.crystals -= costCrystal;

            const card = this.getCardById(cardId);
            if (card) {
                this.discard.push({ ...card });
                this.addLog(`ğŸ”¨ é›é€ æˆåŠŸï¼š${card.name}`, 'success');
            }
            this.updateUI();
        }

        upgradeHero(cardId) {
            const handIndex = this.hand.findIndex(c => c.id === cardId);
            if (handIndex === -1) return;
            const hero = this.hand[handIndex];
            if (!hero || !hero.upgradeToId) return;

            if (this.currentXP < hero.xpToUpgrade) { this.addLog(`XP ä¸è¶³ï¼`, 'danger'); return; }

            this.currentXP -= hero.xpToUpgrade;
            const upgradedHero = this.getCardById(hero.upgradeToId);
            if (upgradedHero) {
                this.discard.push({ ...upgradedHero });
                this.addLog(`å‡ç´šï¼š${hero.name} â†’ ${upgradedHero.name}`, 'success');
                // æ¶ˆè€—èˆŠå¡
                this.hand.splice(handIndex, 1);
            }
            this.updateUI();
        }

        nextPhase() {
            if (this.state !== GameState.VILLAGE) return;
            this.state = GameState.COMBAT;
            this.addLog('é€²å…¥æˆ°é¬¥éšæ®µ', 'info');
            this.combat = { heroHandIndex: null, weaponHandIndex: null, targetDistance: null };
            if (this.lane.length === 0) {
                this.addLog('ç„¡æ€ªç‰©ï¼Œé€²å…¥é€²è»', 'info');
                setTimeout(() => this.advanceMonsters(), 200);
            } else {
                this.updateUI();
            }
        }

        selectCombatHero(idx) { if (this.state === GameState.COMBAT) { this.combat.heroHandIndex = idx; this.updateUI(); } }
        selectCombatWeapon(idx) {
            if (this.state === GameState.COMBAT) {
                this.combat.weaponHandIndex = (this.combat.weaponHandIndex === idx) ? null : idx;
                this.updateUI();
            }
        }
        selectCombatTarget(dist) { if (this.state === GameState.COMBAT) { this.combat.targetDistance = dist; this.updateUI(); } }

        performAttack() {
            if (this.state !== GameState.COMBAT) return;
            const { heroHandIndex: hIdx, weaponHandIndex: wIdx, targetDistance: dist } = this.combat;
            
            if (hIdx === null) return this.addLog('è«‹é¸è‹±é›„ï¼', 'danger');
            if (!dist) return this.addLog('è«‹é¸ç›®æ¨™ï¼', 'danger');

            const hero = this.hand[hIdx];
            const weapon = (wIdx !== null) ? this.hand[wIdx] : null;
            const carry = hero?.carry ?? 0;
            const weight = weapon?.weight ?? 0;
            
            if (weapon && carry < weight) return this.addLog(`è² é‡ä¸è¶³ï¼`, 'danger');

            const totalAtk = (hero?.attack || 0) + (weapon?.attack || 0);
            const totalRange = Math.max(hero?.range || 0, weapon?.range || 0);
            
            if (dist > totalRange) return this.addLog(`å°„ç¨‹ä¸è¶³ï¼`, 'danger');

            const target = this.lane.find(m => m.distance === dist);
            if (!target) return this.addLog('ç›®æ¨™ä¸å­˜åœ¨', 'danger');

            this.addLog(`âš”ï¸ æ”»æ“Š ${target.name} (${totalAtk} å‚·å®³)`, 'info');
            target.hp -= totalAtk;
            this.showDamage(dist, totalAtk);

            // æ¶ˆè€—å¡ç‰Œ
            const idxs = [hIdx];
            if (weapon && wIdx !== hIdx) idxs.push(wIdx);
            idxs.sort((a,b) => b-a).forEach(i => {
                this.discard.push(this.hand[i]);
                this.hand.splice(i, 1);
            });

            this.combat = { heroHandIndex: null, weaponHandIndex: null, targetDistance: null };
            
            if (target.hp <= 0) this.killMonster(target);
            else this.addLog(`${target.name} å‰© HP: ${target.hp}`, 'info');
            
            this.updateUI();
        }

        skipCombat() {
            if (this.state === GameState.COMBAT) {
                this.addLog('æˆ°é¬¥çµæŸï¼Œæ€ªç‰©é€²è»', 'info');
                setTimeout(() => this.advanceMonsters(), 200);
            }
        }

        killMonster(monster) {
            const idx = this.lane.indexOf(monster);
            if (idx >= 0) this.lane.splice(idx, 1);
            this.currentXP += monster.xp;
            this.crystals += monster.crystal;
            this.totalScore += monster.score;
            this.addLog(`âœ¨ æ“Šæ®º ${monster.name} (+${monster.xp} XP)`, 'success');
        }

        advanceMonsters() {
            this.state = GameState.MONSTER_ADVANCE;
            this.lane.forEach(mon => mon.distance = (mon.distance || 5) - 1);
            const entered = this.lane.filter(mon => mon.distance <= 0);
            entered.forEach(mon => {
                this.villageHP -= mon.damage;
                this.addLog(`âš ï¸ ${mon.name} è¡å…¥æ‘èŠ (-${mon.damage} HP)`, 'danger');
            });
            this.lane = this.lane.filter(mon => mon.distance > 0);
            
            const newMon = this.spawnMonster();
            if (newMon) this.addLog(`ğŸ‰ å‡ºç¾ï¼š${newMon.name}`, 'info');

            this.updateUI();
            if (this.villageHP <= 0) this.gameOver(false);
            else setTimeout(() => this.endTurn(), 400);
        }

        spawnMonster() {
            const tier = Math.min(3, Math.ceil(this.turn / 7));
            const filtered = CARDPOOL.monsters.filter(m => m.tier <= tier);
            if (!filtered.length) return null;
            const mon = filtered[Math.floor(Math.random() * filtered.length)];
            const spawned = { ...mon, distance: 5, maxHp: mon.hp };
            this.lane.push(spawned);
            return spawned;
        }

        endTurn() {
            this.state = GameState.END_TURN;
            this.hand.forEach(c => this.discard.push(c));
            this.playedCards.forEach(c => this.discard.push(c));
            this.hand = [];
            this.addLog(`å›åˆçµæŸã€‚æ´—ç‰Œ...`, 'info');
            this.updateUI();
            setTimeout(() => { if (this.villageHP > 0) this.nextTurn(); }, 600);
        }

        showDamage(dist, amount) {
            const slot = document.getElementById('laneSlots').children[dist - 1];
            if (slot) {
                const el = document.createElement('div');
                el.className = 'damage-number'; el.textContent = `-${amount}`;
                slot.appendChild(el);
                setTimeout(() => el.remove(), 1000);
            }
        }

        gameOver(win) {
            this.state = GameState.GAME_OVER;
            const modal = document.getElementById('endGameModal');
            document.getElementById('endGameTitle').textContent = win ? 'ğŸ‰ å‹åˆ©ï¼' : 'ğŸ’€ æ•—åŒ—';
            document.getElementById('endGameMessage').textContent = `å¾—åˆ†: ${this.totalScore}`;
            modal.classList.add('active');
        }

        showDeckModal(type) {
            const list = (type === 'deck') ? this.deck : this.discard;
            const container = document.getElementById('deckViewList');
            container.innerHTML = '';
            document.getElementById('deckViewTitle').textContent = (type === 'deck' ? 'ç‰Œåº«' : 'æ£„ç‰Œå †') + ` (${list.length})`;
            list.forEach(c => {
                const item = document.createElement('div');
                item.className = 'card-list-item';
                item.textContent = c.name;
                container.appendChild(item);
            });
            document.getElementById('deckViewModal').classList.add('active');
        }

        addLog(msg, type='info') {
            this.log.unshift({ message: msg, type }); // æ–°æ—¥èªŒåœ¨æœ€ä¸Š
            if (this.log.length > 20) this.log.pop();
            this.updateUI(); // Log update triggers UI update
        }

        updateUI() {
            // Status
            document.getElementById('villageHP').textContent = this.villageHP;
            if (this.villageHP <= 5) document.getElementById('villageHP').classList.add('danger'); else document.getElementById('villageHP').classList.remove('danger');
            document.getElementById('currentXP').textContent = this.currentXP;
            document.getElementById('crystals').textContent = this.crystals;
            document.getElementById('totalScore').textContent = this.totalScore;
            document.getElementById('turnNumber').textContent = this.turn;
            document.getElementById('plazaCoinDisplay').textContent = this.currentGold;
            document.getElementById('deckCount').textContent = this.deck.length;
            document.getElementById('discardCount').textContent = this.discard.length;

            const stateText = { [GameState.DRAW]: 'æŠ½ç‰Œ', [GameState.VILLAGE]: 'æ‘èŠæ•´å‚™', [GameState.COMBAT]: 'æˆ°é¬¥', [GameState.MONSTER_ADVANCE]: 'é€²è»', [GameState.END_TURN]: 'å›åˆçµæŸ' };
            document.getElementById('gameState').textContent = stateText[this.state] || '';

            // Hand
            const handDisplay = document.getElementById('handDisplay');
            handDisplay.innerHTML = '';
            this.hand.forEach((card, idx) => {
                const el = document.createElement('div');
                el.className = 'card';
                if (this.selectedCards.some(s => s.index === idx)) el.classList.add('selected');
                
                let val = card.type;
                if (card.coin) val = `+${card.coin}$`;
                else if (card.xp) val = `+${card.xp}XP`;
                else if (card.damage) val = `${card.damage}DMG`;
                else if (card.attack) val = `${card.attack}ATK`;

                el.innerHTML = `<div class="card-name">${card.name}</div><div class="card-value">${val}</div>`;
                
                // ç‹€æ…‹åˆ¤æ–·
                let selectable = false;
                if (this.state === GameState.VILLAGE) {
                    if (card.coin !== undefined || card.xp !== undefined) selectable = true;
                    if (card.usage === 'village') selectable = true;
                } else if (this.state === GameState.COMBAT) {
                    if (card.type === 'Hero' || card.type === 'Weapon') selectable = true;
                    if (card.usage === 'combat') selectable = true; // æˆ°é¬¥æ³•è¡“
                }

                if (!selectable) el.classList.add('disabled');

                // é»æ“Šäº‹ä»¶
                el.onclick = () => {
                    if (this.state === GameState.VILLAGE) {
                        if (card.coin || card.xp) this.toggleCardSelection(idx);
                    } else if (this.state === GameState.COMBAT) {
                        if (card.type === 'Hero') this.selectCombatHero(idx);
                        if (card.type === 'Weapon') this.selectCombatWeapon(idx);
                    }
                };

                // æ³•è¡“/é“å…·æŒ‰éˆ• (æ‡¸åœé¡¯ç¤º)
                if ((card.usage === 'village' && this.state === GameState.VILLAGE) ||
                    (card.usage === 'combat' && this.state === GameState.COMBAT)) {
                    const btn = document.createElement('button');
                    btn.className = 'card-action-btn';
                    btn.textContent = (card.usage === 'village') ? 'æ‰“å‡º' : 'ç™¼å‹•';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        if (card.usage === 'village') this.playVillageSpell(idx);
                        if (card.usage === 'combat') this.playCombatSpell(idx);
                    };
                    el.appendChild(btn);
                }

                if (this.combat && (this.combat.heroHandIndex === idx || this.combat.weaponHandIndex === idx)) el.classList.add('selected');
                handDisplay.appendChild(el);
            });

            // Confirmation Area
            const confirmArea = document.getElementById('confirmationArea');
            if (this.selectedCards.length > 0) {
                confirmArea.style.display = 'flex';
                const confirmCards = document.getElementById('confirmationCards');
                confirmCards.innerHTML = '';
                this.selectedCards.forEach(item => {
                    const c = item.card;
                    const txt = c.coin ? `+${c.coin}Coin` : `+${c.xp}XP`;
                    confirmCards.innerHTML += `<div class="confirmation-card"><div class="confirmation-card-name">${c.name}</div><div class="confirmation-card-value">${txt}</div></div>`;
                });
            } else {
                confirmArea.style.display = 'none';
            }

            // Lane
            const laneSlots = document.getElementById('laneSlots');
            laneSlots.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const dist = i + 1;
                const slot = document.createElement('div');
                slot.className = 'lane-slot';
                const mon = this.lane.find(m => m.distance === dist);
                
                if (mon) {
                    slot.classList.add('occupied');
                    if (mon.hp < mon.maxHp) slot.classList.add('damaged');
                    slot.innerHTML = `
                        <div class="lane-slot-monster-name">${mon.name}</div>
                        <div class="lane-slot-hp">HP: ${mon.hp}/${mon.maxHp}</div>
                        <div class="lane-slot-distance">è· ${mon.distance}</div>
                    `;
                    if (this.state === GameState.COMBAT) {
                        slot.style.cursor = 'pointer';
                        if (this.combat && this.combat.targetDistance === dist) slot.style.outline = '2px solid #fff';
                        slot.onclick = () => this.selectCombatTarget(dist);
                    }
                } else {
                    slot.innerHTML = `<span style="color: #666; font-size: 10px;">è·é›¢ ${dist}</span>`;
                }
                laneSlots.appendChild(slot);
            }

            // Market
            const marketGrid = document.getElementById('marketGrid');
            if (marketGrid.children.length === 0 && MARKET_CARDS.early.length > 0) {
                // åªåœ¨åˆå§‹åŒ–æ¸²æŸ“ï¼Œé¿å…é–ƒçˆï¼Œæˆ–æ¯æ¬¡é‡ç¹ªäº¦å¯
                marketGrid.innerHTML = '';
                MARKET_CARDS.early.forEach(c => {
                    const el = document.createElement('div');
                    const full = this.getCardById(c.id);
                    const disabled = this.currentGold < c.cost;
                    el.className = `market-item ${disabled ? 'disabled' : ''}`;
                    el.innerHTML = `<div class="market-item-name">${c.name}</div><div class="market-item-cost">${c.cost} Coin</div><div class="market-item-desc">${full.desc||''}</div>`;
                    el.onclick = () => { if (!disabled) this.buyCard(c.id, c.cost); };
                    marketGrid.appendChild(el);
                });
            } else if (marketGrid.children.length > 0) {
                 // Update disabled state
                 Array.from(marketGrid.children).forEach((el, idx) => {
                     const c = MARKET_CARDS.early[idx];
                     const disabled = this.currentGold < c.cost;
                     el.className = `market-item ${disabled ? 'disabled' : ''}`;
                     el.onclick = () => { if (!disabled) this.buyCard(c.id, c.cost); };
                 });
            }

            // Training
            const trainingHeroes = document.getElementById('trainingHeroes');
            trainingHeroes.innerHTML = '';
            const heroMap = new Map();
            this.hand.filter(c => c.type === 'Hero').forEach(h => { if (!heroMap.has(h.class)) heroMap.set(h.class, h); });
            if (heroMap.size === 0) trainingHeroes.innerHTML = '<div class="placeholder-text">æ‰‹ç‰Œç„¡è‹±é›„</div>';
            else {
                heroMap.forEach(h => {
                    if (h.upgradeToId) {
                        const disabled = this.currentXP < h.xpToUpgrade;
                        const el = document.createElement('div'); el.className = 'training-hero-item';
                        el.innerHTML = `<div class="training-hero-info"><div class="training-hero-name">${h.name}</div><div class="training-hero-cost">éœ€ ${h.xpToUpgrade} XP</div></div><button class="training-upgrade-btn" ${disabled?'disabled':''} onclick="game.upgradeHero('${h.id}')">å‡ç´š</button>`;
                        trainingHeroes.appendChild(el);
                    }
                });
            }

            // Crafting
            const craftingList = document.getElementById('craftingList');
            craftingList.innerHTML = '';
            CRAFTING_RECIPES.forEach(r => {
                const disabled = this.currentGold < r.costCoin || this.crystals < r.costCrystal;
                const el = document.createElement('div'); el.className = 'crafting-item';
                el.innerHTML = `<div class="crafting-info"><div class="crafting-name">${r.name}</div><div class="crafting-cost">${r.desc}</div></div><button class="crafting-btn" ${disabled?'disabled':''} onclick="game.craftCard('${r.id}', ${r.costCoin}, ${r.costCrystal})">é›é€ </button>`;
                craftingList.appendChild(el);
            });

            // Log
            const logContent = document.getElementById('gameLog');
            logContent.innerHTML = '';
            this.log.forEach(l => {
                const el = document.createElement('div'); el.className = `log-entry ${l.type}`; el.textContent = l.message;
                logContent.appendChild(el);
            });

            // Buttons
            document.getElementById('nextPhaseBtn').disabled = this.state !== GameState.VILLAGE;
            document.getElementById('endTurnBtn').disabled = true;

            // Combat Info
            if (this.state === GameState.COMBAT) {
                const { heroHandIndex, weaponHandIndex, targetDistance } = this.combat;
                const h = (heroHandIndex !== null) ? this.hand[heroHandIndex] : null;
                const w = (weaponHandIndex !== null) ? this.hand[weaponHandIndex] : null;
                const atk = (h?.attack||0) + (w?.attack||0);
                const rng = Math.max(h?.range||0, w?.range||0);
                document.getElementById('combatSummary').textContent = `è‹±é›„:${h?.name||'-'} æ­¦å™¨:${w?.name||'-'} ç›®æ¨™è·:${targetDistance||'-'} (ATK:${atk} RNG:${rng})`;
                
                const hasHero = this.hand.some(c => c.type === 'Hero');
                const hasMonster = this.lane.length > 0;
                document.getElementById('combatAttackBtn').disabled = !(hasHero && hasMonster);
            }
        }
    }

    const game = new GuardiansDefenceGame();
    // Start game not auto called, user clicks button
</script>
</body>
</html>

