# 《守護者防線》Prototype - 遊戲設計文檔

**遊戲名稱**：守護者防線 (Guardians Defence)  
**設計參考**：雷霆之石 (Thunderstone) 單人玩法  
**開發版本**：v2.3 (Spell & Craft System)  
**開發日期**：2025年12月  

---

## 目錄

1. [核心遊戲概念](#核心遊戲概念)
2. [勝敗條件](#勝敗條件)
3. [資源系統](#資源系統)
4. [卡牌類型與屬性](#卡牌類型與屬性)
5. [遊戲流程](#遊戲流程)
6. [詳細機制](#詳細機制)
7. [牌庫管理](#牌庫管理)
8. [市場系統](#市場系統)
9. [資料結構參考](#資料結構參考)

---

## 核心遊戲概念

**遊戲類型**：Deck Building + Tower Defense  
**玩家角色**：村莊防衛官（主動構築牌組、徵募英雄、購買裝備與法術）  
**敵人**：怪物軌道上逐漸靠近的敵人（每回合自動進軍）  

**核心循環**：
```
抽牌 → 轉換資源 (Coin/XP) → 購買/升級 → 戰鬥 → 怪物進軍 → 棄牌 → 洗牌 → 下回合
```

---

## 勝敗條件

### 失敗條件
- 村莊血量 (HP) 降至 **0 或以下**
  - 怪物距離變為 ≤ 0 時對村莊造成傷害

### 勝利條件
- **任選其一**：
  1. 撐過 **20 回合** 不被摧毀
  2. 累積分數 ≥ **100** 分

---

## 資源系統

### 1. Coin (金幣)
- **特性**：**每回合清空**
- **產出**：打出「經濟卡」(Economy Cards) 獲得
- **使用**：
  - 購買市場卡牌
  - 鍛造強力卡牌
- **數值範圍**：1 ~ 2 Coin 的卡常見

### 2. XP (經驗值)
- **特性**：**永久保留**（不隨回合結束清空）
- **產出**：擊殺怪物獲得
- **使用**：在訓練場升級英雄
- **消耗機制**：升級英雄時消耗 (3~5 XP)

### 3. Crystals (能量結晶)
- **特性**：永久保留
- **產出**：擊殺特定怪物獲得 (1~2 個)
- **使用**：鍛造強力卡牌（搭配 Coin）
- **難度指標**：資源稀缺，鼓勵玩家有策略地選擇鍛造目標

### 4. HP (村莊血量)
- **初始值**：20 HP
- **消耗來源**：怪物進軍造成傷害
- **補充方式**：打出「治療藥水」等道具卡

### 5. Score (累積分數)
- **產出**：擊殺怪物獲得 (2~15 分)
- **用途**：決定勝利條件之一（≥ 100 分）
- **難度等級**：分數越高的怪物，血量與傷害越強

---

## 卡牌類型與屬性

### 卡牌類別

#### 1. **Hero (英雄)**
- **屬性**：
  - `attack`: 基礎攻擊力 (1~4)
  - `range`: 射程 (1~5)
  - `carry`: 負重容量 (2~6)
  - `class`: 職業分類 (Warrior / Ranger / Mage / Rogue)
  - `xpToUpgrade`: 升級所需 XP
  - `upgradeToId`: 升級目標卡 ID

- **數據例**：
  ```
  戰士(Lv1): ATK 2, RNG 1, CARRY 4, 需 3 XP 升級到 Lv2
  射手(Lv1): ATK 1, RNG 3, CARRY 3
  法師(Lv1): ATK 1, RNG 4, CARRY 2
  盜賊(Lv1): ATK 1, RNG 2, CARRY 3, 被動金流 +1 Coin
  ```

#### 2. **Weapon (武器)**
- **屬性**：
  - `attack`: 額外攻擊力 (1~4)
  - `range`: 額外射程 (1~4)
  - `weight`: 重量 (需符合英雄負重)

- **使用規則**：
  - **可選搭配**英雄（非強制）
  - 必須滿足英雄負重：`英雄.carry >= 武器.weight`
  - 最終射程：`max(英雄.range, 武器.range)`
  - 最終攻擊力：`英雄.attack + 武器.attack`

#### 3. **Economy (經濟卡)**
- **屬性**：
  - `coin`: 提供的金幣數 (1~2)

- **例**：銅幣 (+1 Coin)、銀幣 (+2 Coin)、紅寶石 (+2 Coin)

#### 4. **Spell (法術卡)**
- **屬性**：
  - `usage`: 使用時機 (`village` 或 `combat`)
  - 其他屬性（效果依類型而異）

- **兩類型**：
  
  | 類型 | 使用時機 | 效果 | 例子 |
  |------|--------|------|------|
  | 村莊法術 | 村莊整備階段 | 增加資源或補血 | 抽牌術 (Draw 2)、治療藥水 |
  | 戰鬥法術 | 戰鬥階段 | 直接傷害敵人 | 爆裂火焰 (Damage 3) |

#### 5. **Item (道具)**
- **屬性**：
  - `usage`: 使用時機 (`village` 或 `combat`)
  - 其他屬性（例如 `xp`、恢復 HP 等）

- **例**：治療藥水 (恢復 3 HP)、經驗捲軸 (+2 XP)

#### 6. **Monster (怪物)**
- **屬性**：
  - `hp`: 血量
  - `damage`: 對村莊造成的傷害
  - `xp`: 擊殺獲得的 XP
  - `score`: 擊殺獲得的分數
  - `crystal`: 擊殺獲得的結晶
  - `tier`: 強度等級 (1~3，隨回合增加)

- **例**：
  ```
  哥布林: HP 3, DMG 1, XP 1, Score 2, Crystal 1, Tier 1
  幼龍: HP 12, DMG 5, XP 8, Score 15, Crystal 2, Tier 3
  ```

---

## 遊戲流程

### 完整一個回合 (1 Turn)

```
┌─────────────────────────────────────────────────────┐
│ 回合開始 (DRAW 階段)                                 │
├─────────────────────────────────────────────────────┤
│ 1. 從牌庫抽 6 張牌                                   │
│    (若牌庫空，將棄牌堆洗牌後組成新牌庫)            │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│ 村莊整備階段 (VILLAGE 階段)                          │
├─────────────────────────────────────────────────────┤
│ 2. 打出經濟卡換取 Coin                              │
│ 3. 在市場購買新卡牌                                 │
│ 4. 在訓練場升級英雄 (消耗 XP)                       │
│ 5. 在鍛造處製作強力卡牌 (消耗 Coin + Crystal)      │
│ 6. 打出村莊法術 (抽牌、補血等)                     │
│    → 玩家點擊「下一個階段」按鈕進入戰鬥             │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│ 戰鬥階段 (COMBAT 階段)                               │
├─────────────────────────────────────────────────────┤
│ 7. 選擇手牌中的英雄                                 │
│ 8. (可選) 搭配武器                                   │
│ 9. 選擇軌道上的怪物目標 (距離 1~5)                 │
│ 10. 檢核：                                          │
│    - 負重：英雄.carry >= 武器.weight                │
│    - 射程：max(英雄.range, 武器.range) >= 距離     │
│ 11. 發動攻擊                                        │
│    - 造成傷害：英雄.attack + 武器.attack           │
│    - 怪物 HP 減少                                   │
│    - 英雄 & 武器進入棄牌堆                         │
│ 12. (可選) 打出戰鬥法術直接傷害                    │
│    - 無需英雄，獨立攻擊                            │
│    - 法術進入棄牌堆                                │
│ 13. 若怪物 HP ≤ 0，擊殺並獲得 XP/Crystal/Score  │
│ 14. 重複步驟 7-13，直到玩家點擊「結束戰鬥」      │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│ 怪物進軍階段 (MONSTER_ADVANCE 階段)                 │
├─────────────────────────────────────────────────────┤
│ 15. 軌道上所有怪物距離 -1                           │
│ 16. 距離 ≤ 0 的怪物對村莊造成傷害，移除            │
│ 17. 生成一隻新怪物在距離 5 的位置                  │
│     (強度 tier 依回合數遞增)                       │
│ 18. 檢查勝敗：                                      │
│     - 若村莊 HP ≤ 0 → 失敗                          │
│     - 若分數 ≥ 100 或回合 ≥ 20 → 勝利            │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│ 回合結束 (END_TURN 階段)                             │
├─────────────────────────────────────────────────────┤
│ 19. 手牌中所有未使用的卡進入棄牌堆                 │
│ 20. Coin 清空 (歸 0)                                │
│ 21. XP 保留 (不清空)                                │
│ 22. 回到「回合開始」→ 回合數 +1                     │
└─────────────────────────────────────────────────────┘
```

---

## 詳細機制

### 1. 英雄升級機制 (Hero Upgrade)

**觸發時機**：村莊整備階段  
**前置條件**：
- 手牌中有該英雄的低階版本
- 累積 XP ≥ 升級所需 XP

**執行步驟**：
1. 消耗所需 XP (例如：Lv1 → Lv2 需 3 XP)
2. **從手牌中移除低階英雄**（不進入棄牌堆，直接消耗掉）
3. 高階英雄進入棄牌堆
4. 下回合洗牌時，高階英雄會進入牌庫

**關鍵規則**：
- 升級是「轉化」，不是「增加」
- 低階英雄消失，高階英雄才出現

### 2. 戰鬥機制 (Combat)

#### 2.1 多次攻擊 (Multiple Attacks)
- 同一回合可執行 **無限次攻擊**（直到手牌資源耗盡或玩家主動結束）
- 每次攻擊後，使用的英雄 & 武器必須棄掉，需重新選擇

#### 2.2 物理攻擊 (Hero Attack)
**流程**：
```
選英雄 → (可選) 搭配武器 → 選目標 → 檢核 → 造成傷害 → 棄牌
```

**檢核項目**：
1. **負重檢核**：
   - 若無武器：自動通過
   - 若有武器：`英雄.carry >= 武器.weight` → 通過，否則提示「負重不足」

2. **射程檢核**：
   - 計算最終射程：`final_range = max(英雄.range, 武器.range)`
   - 檢查：`final_range >= 怪物.distance` → 通過，否則提示「射程不足」

**傷害計算**：
```javascript
damage = 英雄.attack + (武器.attack || 0);
怪物.hp -= damage;
```

#### 2.3 法術攻擊 (Spell Attack - Combat)
**觸發時機**：戰鬥階段，手牌中的「戰鬥法術」

**流程**：
```
選法術 → 選目標 → 發動 → 造成傷害 → 法術棄掉
```

**特點**：
- **獨立攻擊**：不需搭配英雄，直接造成固定傷害
- **無負重限制**
- **無射程限制**（視為遠距法術）

### 3. 法術系統 (Spell System - Scheme C)

#### 3.1 村莊法術 (Village Spells)
**使用時機**：村莊整備階段  
**特點**：增加資源或恢復 HP

**例**：
- **抽牌術**：打出 → 抽 2 張牌 → 進入棄牌堆
- **治療藥水**：打出 → 村莊恢復 3 HP → 進入棄牌堆

#### 3.2 戰鬥法術 (Combat Spells)
**使用時機**：戰鬥階段  
**特點**：直接對怪物造成傷害

**例**：
- **爆裂火焰**：發動 → 造成 3 傷害 → 進入棄牌堆
- **大火球術**：發動 → 造成 5 傷害 → 進入棄牌堆

### 4. 鍛造系統 (Crafting System)

**觸發時機**：村莊整備階段  
**前置條件**：Coin 與 Crystals 足夠

**配方結構**：
```javascript
{
  id: '卡牌ID',
  name: '卡牌名',
  costCoin: 消耗Coin數,
  costCrystal: 消耗結晶數,
  desc: '描述'
}
```

**執行步驟**：
1. 檢查資源：`currentCoin >= costCoin && crystals >= costCrystal`
2. 消耗資源
3. 產出卡牌進入棄牌堆
4. 下回合洗牌時，新卡進入牌庫

**例**：
```
魔法劍：需 5 Coin + 1 Crystal
→ 消耗資源 → 獲得 (ATK 4, RNG 1, Weight 3 的武器)

大火球術：需 3 Coin + 1 Crystal
→ 消耗資源 → 獲得 (DMG 5 的戰鬥法術)
```

### 5. 怪物進軍 (Monster Advance)

**步驟**：
1. 所有軌道怪物距離 -1
2. 距離 ≤ 0 的怪物：
   - 對村莊造成傷害
   - 移除出軌道
3. 生成新怪物在距離 5

**強度遞進**：
```
Tier 1 (回合 1-7):   弱小怪物 (HP 2-5, DMG 1-2, XP 1-2)
Tier 2 (回合 8-14):  中等怪物 (HP 6-8, DMG 2-3, XP 3-4)
Tier 3 (回合 15+):   強力怪物 (HP 10+, DMG 4+, XP 6+)
```

---

## 牌庫管理

### 1. 牌庫結構

| 區域 | 說明 | 特性 |
|------|------|------|
| **Deck** | 抽牌堆 | 玩家抽牌時從此堆抽取 |
| **Hand** | 手牌 | 當前回合的可用卡牌 |
| **Discard** | 棄牌堆 | 已使用或淘汰的卡牌 |
| **Lane** | 軌道 | 當前軌道上的怪物 |

### 2. 牌庫循環

```
回合開始 → 從 Deck 抽 6 張
          ↓
    [Deck 空了？]
          ↓
    將 Discard 洗牌後組成新 Deck
          ↓
    繼續抽牌
```

### 3. 卡牌流向

```
購買 → Discard
升級 (舊牌消耗, 新牌) → Discard
鍛造 → Discard
使用 (英雄/武器/法術) → Discard
回合結束 (手牌未使用) → Discard
         ↓
      洗牌 (每回合開始)
         ↓
      組成新 Deck
```

### 4. 查看牌堆 (View Deck)

**功能**：點擊「牌庫: X」或「棄牌: Y」按鈕，彈出 Modal 顯示具體有哪些卡

**用途**：幫助玩家驗證遊戲邏輯、算牌、規劃策略

---

## 市場系統

### 1. 市場卡牌池 (Market Cards)

**定義**：遊戲中可購買的卡牌集合

**例 (Early Game)**：
```javascript
MARKET_CARDS = {
  early: [
    { id: 'hero_warrior_lv1', name: '戰士(Lv1)', cost: 3 },
    { id: 'weapon_iron_sword', name: '鐵劍', cost: 4 },
    { id: 'eco_silver_coin', name: '銀幣', cost: 2 },
    { id: 'spell_draw_1', name: '抽牌術', cost: 2 },
    { id: 'spell_damage', name: '爆裂火焰', cost: 3 },
    ...
  ]
}
```

### 2. 購買機制

**觸發時機**：村莊整備階段  
**前置條件**：`currentCoin >= cardCost`

**執行步驟**：
1. 玩家點擊市場中的卡牌
2. 扣除 Coin
3. 卡牌進入棄牌堆
4. 下回合洗牌後進入牌庫

### 3. 市場更新

**當前設計**：市場卡牌池固定（早期遊戲用）  
**未來擴展**：可考慮依回合/分數/Tier 動態更新市場

---

## 資料結構參考

### 卡牌資料庫 (CARDPOOL)

```javascript
const CARDPOOL = {
  heroes: [
    {
      id: 'hero_warrior_lv1',
      name: '戰士(Lv1)',
      class: 'Warrior',
      attack: 2,
      range: 1,
      carry: 4,
      xpToUpgrade: 3,           // 升級所需 XP
      upgradeToId: 'hero_warrior_lv2',  // 升級目標
      desc: '近戰硬打型'
    },
    ...
  ],
  weapons: [
    {
      id: 'weapon_iron_sword',
      name: '鐵劍',
      attack: 2,
      range: 1,
      weight: 3,
      desc: '堅固的鐵劍'
    },
    ...
  ],
  economy: [
    {
      id: 'eco_silver_coin',
      name: '銀幣',
      coin: 2,
      desc: '常見貨幣 +2'
    },
    ...
  ],
  spells: [
    {
      id: 'spell_draw_1',
      name: '抽牌術',
      usage: 'village',    // 'village' 或 'combat'
      desc: '【村莊】抽 2 張牌'
    },
    {
      id: 'spell_damage',
      name: '爆裂火焰',
      usage: 'combat',
      damage: 3,           // 戰鬥法術特有
      desc: '【戰鬥】造成 3 傷害'
    },
    ...
  ],
  items: [
    {
      id: 'item_heal',
      name: '治療藥水',
      usage: 'village',
      desc: '恢復 3 血'
    },
    ...
  ],
  monsters: [
    {
      id: 'mon_goblin',
      name: '哥布林',
      hp: 3,
      maxHp: 3,
      damage: 1,
      xp: 1,
      score: 2,
      crystal: 1,
      tier: 1
    },
    ...
  ]
};
```

### 遊戲狀態 (Game State)

```javascript
class GuardiansDefenceGame {
  // 遊戲狀態
  state = GameState.IDLE;  // IDLE | DRAW | VILLAGE | COMBAT | MONSTER_ADVANCE | END_TURN | GAME_OVER
  turn = 0;                 // 當前回合數

  // 資源
  villageHP = 20;           // 村莊血量
  currentGold = 0;          // 當前 Coin (每回合清空)
  currentXP = 0;            // 累積 XP (永久保留)
  crystals = 0;             // 結晶 (永久保留)
  totalScore = 0;           // 累積分數

  // 牌組
  deck = [];                // 牌庫
  hand = [];                // 手牌
  discard = [];             // 棄牌堆
  
  // 怪物軌道
  lane = [];                // [{ id, name, hp, distance, ... }]
  
  // UI 狀態
  selectedCards = [];       // 選中的卡 (村莊階段)
  playedCards = [];         // 本回合打出的卡 (未棄掉)
  combat = {                // 戰鬥選擇
    heroHandIndex: null,
    weaponHandIndex: null,
    targetDistance: null
  };
  
  log = [];                 // 遊戲日誌
}
```

---

## 開發版本歷程

| 版本 | 新增功能 | 關鍵修正 |
|------|--------|--------|
| v2.0 | 基礎戰鬥、英雄升級 | - |
| v2.1 | 村莊廣場、市場、訓練場 | - |
| v2.2 | 多次攻擊、傷害動畫、受傷提示、XP 保留 | 移除回合清空 XP |
| v2.3 | 法術系統 (Scheme C)、鍛造系統、查看牌堆 | 升級時消耗舊卡 |

---

## 後續開發方向

### 短期 (v2.4)
- [ ] 職業協同系統 (Warrior + Sword = 攻擊 +1)
- [ ] 簡單的圖示/icon 系統
- [ ] 更多法術卡與鍛造配方

### 中期 (v3.0)
- [ ] 多種難度等級
- [ ] 存檔系統 (LocalStorage)
- [ ] 成就系統
- [ ] 回合統計面板

### 長期 (v3.5+)
- [ ] 多人對戰模式
- [ ] 動態市場系統
- [ ] 英雄技能樹
- [ ] 怪物特殊能力

---

## 遊戲設計核心哲學

1. **簡化的 Deck Building**：不需複雜的牌組編輯器，重點在於回合內的動態決策
2. **多元的戰鬥抉擇**：英雄、武器、法術、目標選擇，提供戰術深度
3. **資源管理**：Coin (短期) vs XP (長期) 的平衡，鼓勵前期累積與後期爆發
4. **怪物進軍的緊迫感**：自動推進，玩家必須主動應對，營造 Tower Defense 氛圍
5. **易學難精**：規則清晰，但策略多元

---

**文檔版本**：v2.3 (2025-12-30)  
**對應 HTML 版本**：v2.3 Prototype  
**下次討論時**：配合此文檔 + 最新 HTML，可快速進入開發狀態
