<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ˆè­·è€…é˜²ç·š - æ ¸å¿ƒç³»çµ± v1.0</title>
    <link rel="stylesheet" href="style.css?v=3.27.NavFix">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="layout-grid">
        <!-- 1. LEFT PANEL: Status (Desktop) / Top Bar (Mobile) -->
        <aside id="statsPanel" class="panel-sidebar">
            <div class="app-brand" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                <a href="index.html"
                    style="color: #4facfe; font-size: 12px; text-decoration: none; margin-bottom: 2px;">â†© å›ä¸»é¸å–®</a>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <h1 style="margin: 0; font-size: 18px;">GD</h1>
                    <span id="appVersion" style="font-size: 11px; color: #666;"></span>
                </div>
                <!-- Mobile Brand -->
                <span class="desktop-title" style="font-size: 10px; color: #555;">Guardians Defence</span>
            </div>

            <div class="stats-container">
                <!-- v3.23.4: Shield Redesign (Overlay Text) -->
                <div class="stat-card shield-stat">
                    <div class="shield-label-group">
                        <span class="stat-icon">ğŸ›¡ï¸</span>
                        <label>é­”æ³•è­·ç½©</label>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="shieldBar"></div>
                        <span class="stat-value-text" id="villageHP">20</span>
                    </div>
                </div>

                <div class="stat-card turn-stat">
                    <div class="stat-info">
                        <label>å›åˆ</label>
                        <span class="stat-value-text" id="turnNumber">1</span>
                    </div>
                </div>

                <div class="stat-card xp-stat">
                    <div class="stat-info">
                        <label>ç¶“é©— / æˆ°æœ</label>
                        <span class="stat-value-text"><span id="currentXP">0</span> XP | <span id="totalScore">0</span>
                            VP</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 2. CENTER PANEL: Main Stage -->
        <main id="stageArea" class="main-stage">

            <!-- Log Panel (Fixed Top/Left) -->
            <div id="logPanel" class="stage-section">
                <div class="panel-header" style="padding-bottom: 5px; margin-bottom: 5px; min-height: auto;">
                    <h3 style="font-size: 12px; margin: 0;">ğŸ“œ å†’éšªæ—¥èªŒ</h3>
                </div>
                <div class="log-content expanded-log" id="gameLog">
                    <div class="log-entry info">ç³»çµ±åˆå§‹åŒ–å®Œæˆ...</div>
                </div>
            </div>

            <!-- Scrollable Game Content -->
            <div id="stageContent">
                <!-- Auto-start handled by update below, removing manual button -->
                <div id="headerActions" class="stage-section" style="display:none;"></div>

                <!-- Dungeon Hall -->
                <div id="dungeonPanel" class="stage-section panel-card">
                    <div class="panel-header">
                        <h3>âš”ï¸ åœ°åŸå¤§å»³</h3>
                    </div>
                    <div class="lane-display">
                        <div class="lane-track" id="laneTrack">
                            <div class="lane-village">ğŸ°</div>
                            <div class="dungeon-rank-slots" id="dungeonRankSlots"></div>
                        </div>
                    </div>
                    <div id="debugDeckInspector"></div>
                </div>

                <!-- Action Selection -->
                <div id="actionSelectPanel" class="stage-section panel-card action-panel">
                    <div class="panel-header">
                        <h3>ğŸš© è¡Œå‹•</h3>
                    </div>
                    <div class="action-buttons-grid">
                        <button class="btn btn-action" id="btnVisitVillage">
                            <span class="btn-icon">ğŸª</span> é€ è¨ªæ‘èŠ
                        </button>
                        <button class="btn btn-action" id="btnRest">
                            <span class="btn-icon">ğŸ’¤</span> ä¼‘æ¯æ•´è£œ
                        </button>
                        <button class="btn btn-action btn-danger" id="btnEnterDungeon">
                            <span class="btn-icon">âš”ï¸</span> é€²å…¥åœ°åŸ
                        </button>
                    </div>
                </div>

                <!-- Dynamic Panels (Combat / Rest) -->
                <div id="dynamicPanels" class="stage-section">
                    <!-- Rest Panel -->
                    <div id="restPanel" class="panel-card active-mode-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>ğŸ’¤ ä¼‘æ¯ä¸­</h3>
                        </div>
                        <div class="panel-body">
                            <div style="margin-bottom: 10px; color: #aaa;">å·²ç²å¾— 1 XPã€‚é»æ“Šæ‰‹ç‰Œå¯éŠ·æ¯€å¡ç‰‡ã€‚</div>
                            <button class="btn btn-secondary" onclick="window.game.finishAction()">å®Œæˆè¡Œå‹•</button>
                        </div>
                    </div>

                    <!-- Combat Panel -->
                    <div id="combatPanel" class="panel-card active-mode-panel" style="display: none;">
                        <div class="panel-header">
                            <h3>ğŸ—¡ï¸ æˆ°é¬¥æŒ‡æ®</h3>
                        </div>
                        <div id="combatHeroList" class="combat-hero-slots"
                            style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                        <div id="combatSummary" class="combat-log" style="margin: 15px 0;">å°šæœªéƒ¨ç½²è‹±é›„...</div>
                        <div class="panel-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-primary btn-glow" id="combatAttackBtn">åŸ·è¡Œæ”»æ“Š</button>
                            <button class="btn btn-secondary" onclick="window.game.finishAction()">æ’¤é€€ / çµæŸ</button>
                        </div>
                    </div>
                </div>

                <!-- Village / Market -->
                <div id="villagePanel" class="stage-section panel-card village-panel">
                    <div class="panel-header">
                        <h3>ğŸ›ï¸ æ‘èŠå¸‚é›†</h3>
                        <div class="coin-badge" style="background: #333; padding: 5px 10px; border-radius: 4px;">
                            ğŸ’° <span id="plazaCoinDisplay">0</span>
                        </div>
                    </div>
                    <!-- Controls for finishing village actions (hidden by default) -->
                    <div id="villageFinishControl"
                        style="margin: 10px 0; display: none; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-primary" onclick="window.game.finishAction()">çµæŸæ‘èŠè¡Œå‹•</button>
                    </div>

                    <!--
                <div class="plaza-tabs" style="margin-bottom: 15px;">
                    <button class="plaza-tab-btn active" id="tab-market">å»£å ´å¸‚é›†</button>
                </div>
                -->
                    <!-- Market Content injected by JS -->
                    <div id="marketTab" class="plaza-content active">
                        <div id="marketGrid" class="market-display-grid"></div>
                    </div>
                    <div id="trainingTab" class="plaza-content">
                        <div id="trainingHeroes"></div>
                    </div>
                </div>

                <!-- Training Panel -->
                <div id="trainingPanel" class="stage-section panel-card training-panel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ‹ï¸ è¨“ç·´å ´</h3>
                    </div>
                    <div id="trainingContent"></div>
                </div>
            </div>
        </main>

        <!-- 3. RIGHT PANEL: Removed (Log moved to Main Stage) -->

        <!-- 4. BOTTOM DOCK: Hand (Drawer on Mobile) -->
        <div id="handDock" class="hand-dock">
            <div class="dock-handle mobile-only" id="handDrawerHandle">
                <span class="handle-bar" style="width: 40px; height: 4px; background: #555; border-radius: 2px;"></span>
                <span class="hand-summary" style="margin-left: 10px; font-size: 12px;">æ‰‹ç‰Œ</span>
            </div>
            <div class="dock-content">
                <div class="hand-controls" style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                    <div class="panel-title desktop-only" style="display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ´ æˆ°ç•¥æ‰‹ç‰Œ</span>
                        <button id="btnAutoActivate" class="btn btn-warning small"
                            style="font-size: 10px; padding: 2px 8px; display: none;"
                            onclick="window.game.villageEngine.activateAllResources()">âš¡ å•Ÿç”¨è³‡æº</button>
                    </div>
                    <div class="deck-status" style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="font-size: 10px; padding: 4px 8px;"
                            onclick="window.ui.showDeck()">ğŸ“š ç‰Œåº« (<span id="btnDeckCountBtn">0</span>)</button>
                        <button class="btn btn-secondary" style="font-size: 10px; padding: 4px 8px;"
                            onclick="window.ui.showDiscard()">ğŸ—‘ï¸ æ£„ç‰Œ (<span id="btnDiscardCountBtn">0</span>)</button>
                    </div>
                </div>
                <div class="hand-area">
                    <div id="playedCardsDisplay" class="played-cards-area" style="display: flex; gap: 5px;"></div>
                    <div class="hand-cards" id="handDisplay" style="display: flex; gap: 10px;"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Mobile Navigation Sidebar -->
    <div id="mobileNav" class="mobile-nav">
        <button class="nav-btn" data-target="dungeonPanel" title="åœ°åŸå¤§å»³">
            <span class="icon">âš”ï¸</span>
        </button>
        <button class="nav-btn" data-target="villagePanel" title="æ‘èŠå¸‚é›†">
            <span class="icon">ğŸ›ï¸</span>
        </button>
        <button class="nav-btn" data-target="actionSelectPanel" title="è¡Œå‹•é¸æ“‡">
            <span class="icon">ğŸš©</span>
        </button>
    </div>

    <!-- Modals (Overlay) -->
    <div id="deckModal" class="modal-overlay">
        <div class="modal-content deck-view">
            <h3 id="deckModalTitle">ç‰Œåº«æª¢è¦–</h3>
            <div id="deckModalContent" class="deck-view-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('deckModal').classList.remove('active')">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content deck-view">
            <h3 id="infoModalTitle">å¡ç‰Œè©³æƒ…</h3>
            <div id="infoModalContent" style="font-size: 14px; line-height: 1.6;"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('infoModal').classList.remove('active')">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- End Game Modal -->
    <div class="modal-overlay" id="endGameModal">
        <div class="modal-content">
            <h2 id="endGameTitle">æˆ°å ±</h2>
            <p id="endGameMessage"></p>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="location.reload()">é‡æ–°å•Ÿå‹•ç³»çµ±</button>
            <button class="btn btn-secondary" style="margin-top: 20px; margin-left: 10px;"
                onclick="window.location.href='index.html'">å›ä¸»é¸å–®</button>
        </div>
    </div>

    <script type="module" src="src/game.js?v=3.29"></script>
    <script>
        // Auto-Start Game
        // Wait for module to load and initialize window.game
        const checkGameReady = setInterval(() => {
            if (window.game) {
                clearInterval(checkGameReady);
                console.log('[Login] Game Interface Ready. Auto-starting...');
                window.game.startNewGame();
            }
        }, 100);
    </script>

    <script>
        // Start Game
        const startBtn = document.getElementById('startGameBtn');
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                if (window.game) window.game.startNewGame();
            });
        }

        // Mobile Drawer Toggle
        const handle = document.getElementById('handDrawerHandle');
        const dock = document.getElementById('handDock');
        if (handle && dock) {
            handle.addEventListener('click', () => {
                dock.classList.toggle('expanded');
            });
        }

        // Mobile Nav Logic
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
</body>

</html>